<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deteksi Emosi Publik Terhadap Kinerja Polisi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="bg-gray-900 text-white w-64 flex flex-col fixed inset-y-0 left-0 z-30 transition-all duration-300"
      >
        <div class="p-4 border-b border-gray-800">
          <h3 class="text-xl font-semibold">
            Deteksi Emosi Publik Terhadap Kinerja Polisi
          </h3>
        </div>
        <nav class="flex-1 pt-4 pb-4">
          <ul>
            <li>
              <a
                href="/upload"
                class="flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 hover:text-white border-l-4 border-transparent"
                id="nav-upload"
              >
                <i class="fas fa-upload mr-3"></i>
                <span>Upload Dataset</span>
              </a>
            </li>
            <li>
              <a
                href="/word-processing"
                class="flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 hover:text-white border-l-4 border-transparent"
                id="nav-word"
              >
                <i class="fas fa-font mr-3"></i>
                <span>Pemrosesan Data (Level Kata)</span>
              </a>
            </li>
            <li>
              <a
                href="/sentence-processing"
                class="flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 hover:text-white border-l-4 border-transparent active"
                id="nav-sentence"
              >
                <i class="fas fa-align-left mr-3"></i>
                <span>Pemrosesan Data (Level Kalimat)</span>
              </a>
            </li>
            <li>
              <a
                href="/training-results"
                class="flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 hover:text-white border-l-4 border-transparent"
                id="nav-training"
              >
                <i class="fas fa-chart-bar mr-3"></i>
                <span>Hasil Pelatihan</span>
              </a>
            </li>
            <li>
              <a
                href="/validation"
                class="flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 hover:text-white border-l-4 border-transparent"
                id="nav-validation"
              >
                <i class="fas fa-check-circle mr-3"></i>
                <span>Uji Validasi</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <!-- Mobile Sidebar Toggle -->
      <div class="lg:hidden fixed top-4 left-4 z-40">
        <button
          id="toggle-sidebar"
          class="p-2 rounded-md bg-blue-600 text-white"
        >
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- Main Content -->
      <div
        id="main-content"
        class="flex-1 ml-64 overflow-y-auto transition-all duration-300"
      >
        <div id="sentence-processing-section" class="p-6">
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-6">
              Pemrosesan Data (Level Kalimat)
            </h2>

            <!-- Status message and progress bar -->
            <div
              id="status-message"
              class="mb-6 p-4 bg-blue-50 text-blue-800 rounded-md"
            >
              Memuat hasil prediksi emosi...
            </div>
            <div class="mb-6 bg-gray-200 rounded-full h-4 overflow-hidden">
              <div
                id="progress-bar"
                class="bg-blue-600 h-4 rounded-full transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>

            <!-- Results explanation -->
            <div class="mb-6">
              <h4 class="text-xl font-semibold mb-4">Hasil Prediksi Emosi</h4>
              <p class="mb-4 text-gray-600">
                Tabel di bawah ini menunjukkan hasil prediksi emosi dari tweet
                yang berkaitan dengan kinerja polisi. Emosi Manual adalah emosi
                yang dianotasi secara manual, sedangkan Emosi Otomatis adalah
                hasil prediksi dari model machine learning.
              </p>
            </div>

            <!-- Results table -->
            <h4 class="text-xl font-semibold mb-4">
              Hasil Perbandingan Prediksi Emosi
            </h4>
            <div class="overflow-auto max-h-96 rounded-lg shadow-md">
              <table class="min-w-full bg-white">
                <thead class="bg-gray-100 sticky top-0">
                  <tr>
                    <th
                      class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b"
                    >
                      No.
                    </th>
                    <th
                      class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b"
                    >
                      Tweet
                    </th>
                    <th
                      class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b"
                    >
                      Token Kata
                    </th>
                    <th
                      class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b"
                    >
                      Emosi Manual
                    </th>
                    <th
                      class="py-3 px-4 text-left text-sm font-semibold text-gray-700 border-b"
                    >
                      Emosi Otomatis
                    </th>
                  </tr>
                </thead>
                <tbody id="sentence-processing-results">
                  <!-- Results will be populated by JavaScript -->
                  <tr>
                    <td colspan="5" class="py-4 px-4 text-center text-gray-500">
                      Memuat data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Navigation buttons -->
            <div class="flex justify-end mt-6">
              <a
                href="/training-results"
                id="view-training-results"
                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
              >
                Lihat Hasil Pelatihan
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API endpoint configuration
      const API_ENDPOINTS = {
        PREDICT_RESULT: "/api/predict-result",
      };

      // Emotion mapping - maps numeric IDs to emotion names and colors
      const emotionMap = {
        1: { name: "Senang", color: "text-green-600" },
        2: { name: "Percaya", color: "text-blue-500" },
        3: { name: "Terkejut", color: "text-purple-600" },
        4: { name: "Netral", color: "text-gray-600" },
        5: { name: "Takut", color: "text-yellow-600" },
        6: { name: "Sedih", color: "text-indigo-600" },
        7: { name: "Marah", color: "text-red-600" },
      };

      // Toggle sidebar on mobile
      document
        .getElementById("toggle-sidebar")
        .addEventListener("click", function () {
          const sidebar = document.getElementById("sidebar");
          const mainContent = document.getElementById("main-content");

          if (sidebar.classList.contains("-ml-64")) {
            sidebar.classList.remove("-ml-64");
            mainContent.classList.remove("ml-0");
          } else {
            sidebar.classList.add("-ml-64");
            mainContent.classList.add("ml-0");
            mainContent.classList.remove("ml-64");
          }
        });

      // Check if mobile on load
      function checkMobile() {
        if (window.innerWidth < 1024) {
          document.getElementById("sidebar").classList.add("-ml-64");
          document.getElementById("main-content").classList.add("ml-0");
          document.getElementById("main-content").classList.remove("ml-64");
        } else {
          document.getElementById("sidebar").classList.remove("-ml-64");
          document.getElementById("main-content").classList.remove("ml-0");
          document.getElementById("main-content").classList.add("ml-64");
        }
      }

      window.addEventListener("resize", checkMobile);
      checkMobile();

      // Function to update status message
      function updateStatus(message, isError = false) {
        const statusElement = document.getElementById("status-message");
        statusElement.textContent = message;

        if (isError) {
          statusElement.classList.remove("bg-blue-50", "text-blue-800");
          statusElement.classList.add("bg-red-50", "text-red-800");
        } else {
          statusElement.classList.remove("bg-red-50", "text-red-800");
          statusElement.classList.add("bg-blue-50", "text-blue-800");
        }
      }

      // Fetch data from API with error handling for NaN values
      async function fetchPredictionResults() {
        try {
          updateStatus("Memuat hasil prediksi emosi dari server...");

          const response = await fetch(API_ENDPOINTS.PREDICT_RESULT);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // Get the raw text response first
          const rawText = await response.text();

          // Try to fix any potential NaN issues by replacing NaN with "NaN"
          const fixedText = rawText.replace(/: NaN/g, ': "NaN"');

          try {
            // Parse the fixed JSON
            const data = JSON.parse(fixedText);
            return validatePredictionData(data);
          } catch (parseError) {
            console.error("Error parsing fixed JSON:", parseError);
            console.log("Problematic JSON:", rawText);
            throw parseError;
          }
        } catch (error) {
          console.error("Error fetching prediction results:", error);
          updateStatus(
            `Error: ${error.message}. Silakan coba lagi nanti.`,
            true
          );
          throw error;
        }
      }

      // Validate prediction data
      function validatePredictionData(data) {
        if (!Array.isArray(data)) {
          console.error("Data is not an array");
          return [];
        }

        // Filter out invalid items
        const validData = data.filter((item) => {
          // Check if required fields exist
          if (!item || typeof item !== "object") return false;
          if (item.tweet === undefined || item.tweet === null) return false;
          if (item.emotion === undefined || item.emotion === null) return false;
          if (item.predict === undefined || item.predict === null) return false;

          // Check for NaN values
          if (
            item.tweet === "NaN" ||
            (typeof item.tweet === "number" && isNaN(item.tweet))
          )
            return false;

          // Check tweet length
          if (typeof item.tweet === "string" && item.tweet.length <= 1)
            return false;

          return true;
        });

        if (validData.length === 0) {
          console.warn("No valid prediction data found");
        } else if (validData.length < data.length) {
          console.warn(
            `Filtered out ${data.length - validData.length} invalid items`
          );
        }

        return validData;
      }

      // Process and parse words if they come as a string representation of list
      function parseWords(wordsData) {
        if (!wordsData) return [];

        // If already an array, return as is
        if (Array.isArray(wordsData)) return wordsData;

        // If a string, try to parse it
        if (typeof wordsData === "string") {
          try {
            // Replace Python-style list formatting with JSON format
            const jsonStr = wordsData
              .replace(/'/g, '"') // Replace single quotes with double quotes
              .replace(/\[|\]/g, ""); // Remove brackets

            // Split by comma and clean up each word
            return jsonStr
              .split(",")
              .map(
                (word) => word.trim().replace(/^"|"$/g, "") // Trim and remove quotes
              )
              .filter((word) => word.length > 0); // Remove empty items
          } catch (e) {
            console.error("Error parsing words string:", e);
            return [wordsData]; // Return the string itself as a fallback
          }
        }

        return [];
      }

      // Display prediction results in the table
      function displayPredictionResults(data) {
        const resultsTable = document.getElementById(
          "sentence-processing-results"
        );
        resultsTable.innerHTML = "";

        if (!data || data.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.className =
            "py-3 px-4 text-sm text-gray-500 text-center border-b";
          cell.textContent = "Tidak ada data prediksi yang tersedia";
          row.appendChild(cell);
          resultsTable.appendChild(row);
          return;
        }

        data.forEach((item, index) => {
          // Process words field
          const wordTokens = parseWords(item.words);

          // Create table row
          const row = document.createElement("tr");
          row.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";

          // No column
          const numberCell = document.createElement("td");
          numberCell.className = "py-3 px-4 text-sm border-b border-gray-200";
          numberCell.textContent = index + 1;
          row.appendChild(numberCell);

          // Tweet column
          const tweetCell = document.createElement("td");
          tweetCell.className = "py-3 px-4 text-sm border-b border-gray-200";
          tweetCell.textContent = item.tweet;
          row.appendChild(tweetCell);

          // Token column (words)
          const tokenCell = document.createElement("td");
          tokenCell.className = "py-3 px-4 text-sm border-b border-gray-200";
          tokenCell.textContent = wordTokens.join(", ");
          row.appendChild(tokenCell);

          // Manual Emotion column (emotion field)
          const manualEmotionCell = document.createElement("td");
          manualEmotionCell.className =
            "py-3 px-4 text-sm border-b border-gray-200 font-semibold";
          const manualEmotionObj = emotionMap[item.emotion] || {
            name: `Unknown (${item.emotion})`,
            color: "text-gray-600",
          };
          manualEmotionCell.textContent = manualEmotionObj.name;
          manualEmotionCell.classList.add(manualEmotionObj.color);
          row.appendChild(manualEmotionCell);

          // Automatic Emotion column (predict field)
          const autoEmotionCell = document.createElement("td");
          autoEmotionCell.className =
            "py-3 px-4 text-sm border-b border-gray-200 font-semibold";
          const autoEmotionObj = emotionMap[item.predict] || {
            name: `Unknown (${item.predict})`,
            color: "text-gray-600",
          };
          autoEmotionCell.textContent = autoEmotionObj.name;
          autoEmotionCell.classList.add(autoEmotionObj.color);

          // Add indicator for match/mismatch
          if (item.emotion === item.predict) {
            // Prediction matches manual annotation - add checkmark
            const checkIcon = document.createElement("i");
            checkIcon.className = "fas fa-check-circle ml-2 text-green-600";
            autoEmotionCell.appendChild(checkIcon);
          } else {
            // Prediction doesn't match - add X mark
            const xIcon = document.createElement("i");
            xIcon.className = "fas fa-times-circle ml-2 text-red-600";
            autoEmotionCell.appendChild(xIcon);
          }

          row.appendChild(autoEmotionCell);

          resultsTable.appendChild(row);
        });
      }

      // Main function to load and process data
      async function processEmotionData() {
        try {
          // Setup progress bar
          const progressBar = document.getElementById("progress-bar");
          let progress = 0;

          // Start progress animation
          const interval = setInterval(() => {
            progress += 2;
            if (progress > 90) progress = 90; // Cap at 90% until data is loaded
            progressBar.style.width = `${progress}%`;
          }, 100);

          // Fetch data from API
          const predictionData = await fetchPredictionResults();

          // Complete progress bar
          clearInterval(interval);
          progress = 100;
          progressBar.style.width = `${progress}%`;

          // Update status message
          updateStatus(
            `Berhasil memuat ${predictionData.length} data prediksi emosi.`
          );

          // Display results
          displayPredictionResults(predictionData);

          return true;
        } catch (error) {
          console.error("Error processing emotion data:", error);

          // Update status with error
          updateStatus(`Terjadi kesalahan: ${error.message}`, true);

          // Complete progress bar (as error)
          const progressBar = document.getElementById("progress-bar");
          progressBar.style.width = "100%";
          progressBar.classList.remove("bg-blue-600");
          progressBar.classList.add("bg-red-600");

          return false;
        }
      }

      // Set active menu item
      document
        .getElementById("nav-sentence")
        .classList.add("active", "border-blue-600");
      document
        .getElementById("nav-sentence")
        .classList.remove("border-transparent");

      // Run processing when page loads
      document.addEventListener("DOMContentLoaded", function () {
        processEmotionData();
      });
    </script>
  </body>
</html>
